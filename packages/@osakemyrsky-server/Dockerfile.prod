FROM node:14.18.0-alpine3.14 AS builder

WORKDIR /build

COPY package.json .
COPY yarn.lock .

RUN yarn install

COPY tsconfig.json .
COPY src src
COPY migrations migrations
COPY typings typings

RUN yarn build

FROM node:14.18.0-alpine3.14 

WORKDIR /app

COPY package.json .
COPY yarn.lock .

RUN yarn install --production && yarn cache clean

COPY --from=builder /build/dist .

CMD ["yarn", "start"]